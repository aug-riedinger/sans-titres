(function(){var a={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},b=["webkit","moz","o","ms","khtml"];if("undefined"!=typeof document.cancelFullScreen)a.supportsFullScreen=!0;else for(var c=0,d=b.length;c<d;c++)if(a.prefix=b[c],"undefined"!=typeof document[a.prefix+"CancelFullScreen"]){a.supportsFullScreen=!0;break}a.supportsFullScreen&&(a.fullScreenEventName=a.prefix+"fullscreenchange",a.isFullScreen=
function(){switch(this.prefix){case "":return document.fullScreen;case "webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},a.requestFullScreen=function(a){return""===this.prefix?a.requestFullScreen():a[this.prefix+"RequestFullScreen"]()},a.cancelFullScreen=function(){return""===this.prefix?document.cancelFullScreen():document[this.prefix+"CancelFullScreen"]()});"undefined"!=typeof jQuery&&(jQuery.fn.requestFullScreen=function(){return this.each(function(){var b=
jQuery(this);a.supportsFullScreen&&a.requestFullScreen(b)})});window.fullScreenApi=a})();var ge1doot=ge1doot||{};ge1doot.tweens={first:!1,prev:!1,iterate:function(){var a=this.first;do a.ease(),a=a.next;while(a)}};
ge1doot.tweens.Add=function(a,b,c,d,e,f){this.target=c||0;this.value=b||0;this.steps=a;this.isAngle=d||!1;this.speedMod=1;this.minValue=e;this.maxValue=f;d&&(this.normalizePI=function(){Math.abs(this.target-this.value)>Math.PI&&(this.value=this.target<this.value?this.value-2*Math.PI:this.value+2*Math.PI)});this.setTarget(this.target,1,!1);ge1doot.tweens.first?ge1doot.tweens.prev.next=this:ge1doot.tweens.first=this;ge1doot.tweens.prev=this};
ge1doot.tweens.Add.prototype.setTarget=function(a,b){this.speedMod=1;b=void 0!==b?b:!0;this.target=a;this.isAngle&&(this.target%=2*Math.PI,this.normalizePI());this.locked=!1;if(b)this.minValue&&a<this.minValue&&(this.target=this.minValue),this.maxValue&&a>this.maxValue&&(this.target=this.maxValue);else if(this.minValue&&a<this.minValue||this.maxValue&&a>this.maxValue)this.locked=!0;this.running&&this.oldTarget===a||(this.oldTarget=a,this.running=!0,this.prog=0,this.from=this.value,this.dist=0.5*-(this.target-
this.from))};ge1doot.tweens.Add.prototype.ease=function(){if(this.running){var a=this.speedMod*this.steps;this.prog++<a?(this.value=this.dist*(Math.cos(Math.PI*(this.prog/a))-1)+this.from,this.isAngle&&this.normalizePI()):(this.running=!1,this.value=this.target)}};
ge1doot.tweens.Add.prototype.setValue=function(a){this.isAngle&&this.normalizePI();this.running=!1;if(!this.locked)return this.minValue&&a<this.minValue?this.target=this.value=this.minValue:this.maxValue&&a>this.maxValue?this.target=this.value=this.maxValue:this.target=this.value=a};var scr,rooms=[],cursor,keyboard,camera,SLOW=!1,cpt=100,showing,params={unit:1E3,height:4E3,focalLength:1E3,humanHeight:300,wallDist:0,artDist:500,cursorX:4,cursorY:6},colors={floor:"#80827d",aimedFloor:"#70726D",top:"#E9E9E9",bottom:"#E9E9E9",left:"#D9D9D9",right:"#D9D9D9"};var Screen=function(a){this.container=document.getElementById(a.container);this.canvas=document.getElementById(a.canvas);this.ctx=this.canvas.getContext("2d");this.setSize();this.initEvents();return this};Screen.prototype.setSize=function(){this.width=this.container.offsetWidth;this.height=this.container.offsetHeight;var a=this.container;for(this.top=this.left=0;null!==a;a=a.offsetParent)this.left+=a.offsetLeft,this.top+=a.offsetTop;this.canvas&&(this.canvas.width=this.width,this.canvas.height=this.height)};
Screen.prototype.initEvents=function(){var a=this;window.addEventListener("resize",function(){a.setSize()},!1);window.addEventListener("keydown",function(a){13==a.keyCode&&window.fullScreenApi.requestFullScreen(document.getElementsByTagName("body")[0])})};var Cursor=function(a,b,c){this.segmentX=b;this.segmentY=c;this.container=document.getElementById(a);this.strengthY=this.strengthX=this.Y=this.X=0;this.going=this.aimedFace=null;this.initEvents();return this};
Cursor.prototype.initEvents=function(){var a=this;this.container.onmspointermove=this.container.ontouchmove=this.container.onmousemove=function(b){a.X=void 0!==b.clientX?b.clientX:b.touches[0].clientX;a.Y=void 0!==b.clientY?b.clientY:b.touches[0].clientY;if(a.muted&&(20<Math.abs(a.muted.X-a.X)||20<Math.abs(a.muted.Y-a.Y)))a.muted=null,console.log("unmuted");a.calcStrength();a.aimedFace=a.inFace();a.setCursor()};this.container.onclick=function(b){var c,d,e;if(a.aimedFace&&(c=parseInt(a.aimedFace.f.id.split(":")[0],
10),"art"===a.aimedFace.f.type&&(d=a.aimedFace.f.artId||null,showHtml(a.aimedFace.html),$("#artInfo").fadeOut(1E3)),"floor"===a.aimedFace.f.type&&(a.aimedFace.f.art?(d=a.aimedFace.f.art.f.artId||null,camera.targetToFace(a.aimedFace),$(scr.canvas).one("inPosition",$.proxy(function(){cursor.mute();$("#artTitle").html(this.f.art.f.info.title||"Inconnu");$("#artAuthor").html(this.f.art.f.info.author||"Inconnu");$("#artDescription").html(this.f.art.f.info.description||"Inconnu");$("#artInfo").fadeIn(1E3,
function(){setTimeout(function(){$("#artInfo").fadeOut(1E3)},3E3)})},a.aimedFace))):(camera.targetToFace(a.aimedFace),c!==rooms[0].id&&enteredRoom(c))),!history.state||history.state.roomId!==c||history.state.artId!==d))e="Sans-titres, Salle "+c+(d?" Oeuvre "+d:""),history.pushState({roomId:c,artId:d},e,"#!room="+c+(d?"&art="+d:"")),document.title=e;b.preventDefault();return!1};this.container.ondblclick=function(a){camera.godView();a.preventDefault();return!1};this.container.onmspointerdown=this.container.ontouchstart=
this.container.onmousedown=function(){};this.container.onmspointerup=this.container.ontouchend=this.container.onmouseup=function(){};this.container.onmspointercancel=this.container.ontouchcancel=function(){}};Cursor.prototype.mute=function(){this.muted={X:this.X,Y:this.Y};this.calcStrength();this.setCursor()};
Cursor.prototype.calcStrength=function(){if(this.muted)return this.strengthX=this.strengthY=0;this.X>scr.width/this.segmentX&&this.X<scr.width-scr.width/this.segmentX&&(this.strengthX=0);this.X<scr.width/this.segmentX&&(this.strengthX=(this.X-scr.width/this.segmentX)/(scr.width/this.segmentX));this.X>scr.width-scr.width/this.segmentX&&(this.strengthX=1-(scr.width-this.X)/(scr.width/this.segmentX));this.Y>scr.height/this.segmentY&&this.Y<scr.height-scr.height/this.segmentY&&(this.strengthY=0);this.Y<
scr.height/this.segmentY&&(this.strengthY=(this.Y-scr.height/this.segmentY)/(scr.height/this.segmentY));this.Y>scr.height-scr.height/this.segmentY&&(this.strengthY=1-(scr.height-this.Y)/(scr.height/this.segmentY))};Cursor.prototype.inTriangle=function(a,b,c){var d=c.X-a.X,e=c.Y-a.Y;c=b.X-a.X;var f=b.Y-a.Y,h=this.X-a.X,g=this.Y-a.Y;a=d*d+e*e;b=d*c+e*f;d=d*h+e*g;e=c*c+f*f;c=c*h+f*g;f=1/(a*e-b*b);h=(e*d-b*c)*f;a=(a*c-b*d)*f;return 0<=h&&0<=a&&1>h+a};
Cursor.prototype.inFace=function(){var a,b,c,d;for(b=0;b<rooms.length;b++){d=rooms[b];for(a=0;a<d.arts.length;a++)if(c=d.arts[a],this.faceSelected(c))return c;for(a=0;a<d.floors.length;a++)if(c=d.floors[a],c.projection(),this.faceSelected(c))return c}return null};Cursor.prototype.faceSelected=function(a){return a.f.select&&a.visible&&(this.inTriangle(a.p0,a.p1,a.p2)||this.inTriangle(a.p0,a.p2,a.p3))};
Cursor.prototype.setCursor=function(){if(0>this.strengthY&&0>this.strengthX)return this.changeClass("top-left");if(0>this.strengthY&&0<this.strengthX)return this.changeClass("top-right");if(0<this.strengthY&&0>this.strengthX)return this.changeClass("bottom-left");if(0<this.strengthY&&0<this.strengthX)return this.changeClass("bottom-right");if(0>this.strengthY)return this.changeClass("top");if(0<this.strengthY)return this.changeClass("bottom");if(0<this.strengthX)return this.changeClass("right");if(0>
this.strengthX)return this.changeClass("left");if(this.aimedFace){if("art"===this.aimedFace.f.type)return this.changeClass("see");if("floor"===this.aimedFace.f.type)return this.changeClass("go")}return this.changeClass("")};Cursor.prototype.changeClass=function(a){if(this.container.className!==a)return this.container.className=a};var Camera=function(a,b){this.focalLength=params.focalLength;this.x=new ge1doot.tweens.Add(100,a,a);this.y=new ge1doot.tweens.Add(100,-8*params.unit,params.height/2-params.humanHeight);this.z=new ge1doot.tweens.Add(100,b,b);this.rx=new ge1doot.tweens.Add(100,-Math.PI/2,0,!0,-Math.PI/36,Math.PI/8);this.ry=new ge1doot.tweens.Add(100,0,0,!0);this.zoom=new ge1doot.tweens.Add(100,1,1);this.trig={cosX:1,cosY:1,sinX:0,sinY:0};return this};
Camera.prototype.isInPosition=function(){var a=this.x.target-this.x.value,b=this.y.target-this.y.value,c=this.z.target-this.z.value;10>a*a+b*b+c*c&&$(scr.canvas).trigger("inPosition")};
Camera.prototype.targetToPosition=function(a,b){b=void 0!==b?b:!0;var c=void 0!==a.y?a.y:params.height/2-params.humanHeight,d=void 0!==a.z?a.z:this.z.target;this.x.setTarget(void 0!==a.x?a.x:this.x.target,b);this.z.setTarget(d,b);this.y.setTarget(c,b);this.rx.setTarget(void 0!==a.rx?a.rx:this.rx.target,b);this.ry.setTarget(void 0!==a.ry?a.ry:this.ry.target,b);this.zoom.setTarget(void 0!==a.zoom?a.zoom:this.zoom.target)};
Camera.prototype.targetToFace=function(a){if("floor"===a.f.type)return a.f.art?this.targetToPosition({x:a.pv.x,z:a.pv.z+this.focalLength,rx:Math.PI/16,ry:a.f.art.f.ry*Math.PI/2,zoom:1},!0):this.targetToPosition({x:a.pv.x,z:a.pv.z+this.focalLength,rx:0,zoom:1},!0)};Camera.prototype.up=function(a){this.targetToPosition({x:this.x.target+params.unit*this.trig.sinY*(a||1),z:this.z.target+params.unit*this.trig.cosY*(a||1)})};
Camera.prototype.down=function(a){this.targetToPosition({x:this.x.target-params.unit*this.trig.sinY*(a||1),z:this.z.target-params.unit*this.trig.cosY*(a||1)})};Camera.prototype.lft=function(a){this.targetToPosition({x:this.x.target-params.unit*this.trig.cosY*(a||1),z:this.z.target+params.unit*this.trig.sinY*(a||1)})};Camera.prototype.rght=function(a){this.targetToPosition({x:this.x.target+params.unit*this.trig.cosY*(a||1),z:this.z.target-params.unit*this.trig.sinY*(a||1)})};
Camera.prototype.left=function(a){this.targetToPosition({ry:this.ry.target+Math.PI/4*(a||1)+2*Math.PI})};Camera.prototype.right=function(a){this.targetToPosition({ry:this.ry.target-Math.PI/4*(a||1)+2*Math.PI})};Camera.prototype.zoomIn=function(){this.zoom.setTarget(1.25*this.zoom.target)};Camera.prototype.zoomOut=function(){this.zoom.setTarget(0.8*this.zoom.target)};
Camera.prototype.stop=function(){this.x.setTarget(this.x.value);this.y.setTarget(this.y.value);this.z.setTarget(this.z.value);this.rx.setTarget(this.rx.value);this.ry.setTarget(this.ry.value);this.zoom.setTarget(this.zoom.value)};Camera.prototype.godView=function(){this.targetToPosition({y:-8*params.unit,rx:-Math.PI/2+0.001},!1)};
Camera.prototype.move=function(){ge1doot.tweens.iterate();0!==cursor.strengthY&&this.rx.target===this.rx.value&&this.rx.setValue(this.rx.value-0.02*cursor.strengthY);0!==cursor.strengthX&&this.ry.target===this.ry.value&&this.ry.setValue(this.ry.value-0.02*cursor.strengthX);this.trig.cosX=Math.cos(this.rx.value);this.trig.sinX=Math.sin(this.rx.value);this.trig.cosY=Math.cos(this.ry.value);this.trig.sinY=-Math.sin(this.ry.value);this.isInPosition()};
Camera.prototype.rotate=function(a,b,c){return{x:this.trig.cosY*a-this.trig.sinY*(c+this.focalLength),y:this.trig.sinX*(this.trig.cosY*(c+this.focalLength)+this.trig.sinY*a)+this.trig.cosX*b,z:this.trig.cosX*(this.trig.cosY*(c+this.focalLength)+this.trig.sinY*a)-this.trig.sinX*b-this.focalLength}};Camera.prototype.coordinates=function(){console.log("c: ("+Math.round(this.x.value/params.unit)+","+Math.round((this.z.value-this.focalLength)/params.unit)+")")};var Point=function(a,b,c){this.face=a;this.x=b[0];this.y=b[1];this.z=b[2];this.Y=this.X=this.distance=this.scale=0;this.inScreen=!1;c&&(this.x+=c.x,this.y+=c.y,this.z+=c.z);this.x=Math.round(this.x);this.y=Math.round(this.y);this.z=Math.round(this.z);return this};
Point.prototype.projection=function(){var a=camera.rotate(this.x-camera.x.value,this.y-camera.y.value,this.z-camera.z.value);this.behind=a.z<=-1*params.focalLength;var b=a.z+camera.focalLength;this.distance=Math.sqrt(a.x*a.x+b*b);this.face&&(this.behind&&(this.face.nbBehind+=1),this.distance>this.face.distance&&(this.face.distance=this.distance));this.scale=Math.abs(camera.focalLength/(a.z+camera.focalLength)*camera.zoom.value)||1E4;this.X=0.5*scr.width+a.x*this.scale+0.5|0;this.Y=0.5*scr.height+
a.y*this.scale+0.5|0;return!0};var Face=function(a){this.f=a;var b=0.5*a.w,c=0.5*a.h,d=0.5*a.rx*Math.PI,e=0.5*a.ry*Math.PI;this.visible=!0;var f=function(a,b,c,d,e){var f=c*Math.cos(e)+a*Math.sin(e),p=b*Math.cos(d)+f*Math.sin(d);return{x:a*Math.cos(e)-c*Math.sin(e),y:p,z:f*Math.cos(d)-b*Math.sin(d)}};this.pc=new Point(this,[a.x,a.y,a.z]);this.p0=new Point(this,[a.x,a.y,a.z],f(-b,-c,0,d,e));this.p1=new Point(this,[a.x,a.y,a.z],f(b,-c,0,d,e));this.p2=new Point(this,[a.x,a.y,a.z],f(b,c,0,d,e));this.p3=new Point(this,[a.x,a.y,a.z],
f(-b,c,0,d,e));this.points=[this.p0,this.p1,this.p2,this.p3];this.pv=this.makePv();b=f(d,e,0,d,e,0);this.ax=b.x+Math.PI/2;this.ay=b.y+Math.PI/2;"art"===this.f.type&&(this.img=new CanvasEl.Image(scr.canvas,this.f.thumb,a.tl||2));this.buffer();return this};
Face.prototype.makePv=function(){if(this.f.adj){var a=[],b;for(i=0;i<this.points.length;i++){b=!1;for(j=0;j<this.f.adj.length;j++)if(this.f.adj[j])for(k=0;k<this.f.adj[j].points.length;k++)equalsCoord(this.points[i],this.f.adj[j].points[k])&&(b=!0);b||a.push(this.points[i])}var c,d;for(i=d=c=b=0;i<a.length;i++)b+=a[i].x,c+=a[i].y,d+=a[i].z;b/=a.length;c/=a.length;d/=a.length;this.res=a;return new Point(null,[b,c,d])}return this.pc};
Face.prototype.projection=function(){this.conditions=this.distance=this.nbBehind=0;this.visible=!0;this.distance=-99999;this.p0.projection();this.p1.projection();this.p2.projection();this.p3.projection();if(this.forceVisible)return this.visible=!0;1<this.nbBehind?(this.visible=!1,this.distance=-99999,this.conditions+=40):0<(this.p3.Y-this.p2.Y)*(this.p1.X-this.p2.X)-(this.p3.X-this.p2.X)*(this.p1.Y-this.p2.Y)&&(this.visible=!1,this.distance=-99999,this.conditions+=2)};
Face.prototype.buffer=function(){"art"===this.f.type&&"image"===this.f.subtype&&(this.html=new Image,this.html.src=this.f.src,this.html.id=this.f.id,this.html.className="art");"art"===this.f.type&&"html"===this.f.subtype&&(this.html=document.createElement("iframe"),this.html.setAttribute("src",this.f.src),this.html.className="html",this.html.id=this.f.id,this.html.height=this.f.iFrameHeight||600,this.html.width=this.f.iFrameWidth||800)};
Face.prototype.render=function(){"art"===this.f.type&&(cursor.aimedFace&&this.f.id===cursor.aimedFace.f.id?this.img.render(this.p0,this.p1,this.p2,this.p3,"black"):this.img.render(this.p0,this.p1,this.p2,this.p3,"white"))};
var faceMaker={top:function(a,b,c){return new Face({id:a.id+":"+b+":"+c+":top",type:"top",x:params.unit*(b+a.position.x),y:0,z:params.unit*(c+0.5+a.position.z),rx:0,ry:0,w:params.unit,h:params.height,select:!1})},bottom:function(a,b,c){return new Face({id:a.id+":"+b+":"+c+":bottom",type:"bottom",x:params.unit*(b+a.position.x),y:0,z:params.unit*(c-0.5+a.position.z),rx:0,ry:-2,w:params.unit,h:params.height,select:!1})},left:function(a,b,c){return new Face({id:a.id+":"+b+":"+c+":left",type:"left",x:params.unit*
(b-0.5+a.position.x),y:0,z:params.unit*(c+a.position.z),rx:0,ry:1,w:params.unit,h:params.height,select:!1})},right:function(a,b,c){return new Face({id:a.id+":"+b+":"+c+":right",type:"right",x:params.unit*(b+0.5+a.position.x),y:0,z:params.unit*(c+a.position.z),rx:0,ry:-1,w:params.unit,h:params.height,select:!1})},ceiling:function(a,b,c){return new Face({id:a.id+":"+b+":"+c+":ceiling",type:"ceiling",x:params.unit*(b+a.position.x),y:-params.height/2,z:params.unit*(c+a.position.z),rx:-1,ry:0,w:params.unit,
h:params.unit,select:!1})},floor:function(a,b,c,d,e){a={id:a.id+":"+b+":"+c+":floor",type:"floor",x:params.unit*(b+a.position.x),y:params.height/2,z:params.unit*(c+a.position.z),rx:1,ry:0,w:params.unit,h:params.unit,adj:d,select:!0};void 0!==e&&(a.art=e);return new Face(a)},door:function(a,b,c){return new Face({id:a.id+":"+Math.floor(b.f.x/params.unit)+":"+Math.floor(b.f.z/params.unit)+":door",type:"door",x:b.f.x,y:b.f.y,z:b.f.z,rx:b.f.rx,ry:b.f.ry,w:b.f.w,h:b.f.h,to:c.to,select:!0})},art:function(a,
b,c){return new Face({id:a.id+":"+Math.floor(b.f.x/params.unit)+":"+Math.floor(b.f.z/params.unit)+":art",type:"art",subtype:c.type,x:b.f.x,y:params.height/2-1.8*params.humanHeight,z:b.f.z,rx:b.f.rx,ry:b.f.ry,w:c.width,h:c.height,thumb:c.thumb,src:c.src,info:c.info||{},iFrameHeight:c.iFrameHeight,iFrameWidth:c.iFrameWidth,artId:c.id,select:!0})},position:function(a,b){var c={id:a.id+":"+Math.floor(b.f.x/params.unit)+":"+Math.floor(b.f.z/params.unit)+":position",type:"position",x:parseInt(b.f.x+params.unit*
Math.sin(b.f.ry*Math.PI/2),10),y:params.height/2,z:parseInt(b.f.z-params.unit*Math.cos(b.f.ry*Math.PI/2),10),rx:1,ry:0,w:500,h:500,ryf:b.f.ry,info:b.f.info||{},art:b,select:!0};return new Face(c)}};var Room=function(a,b){this.id=a;this.mainRoom=b;this.arts=[];this.sounds=[];this.adj=[];this.positions=[];this.tops=[];this.bottoms=[];this.lefts=[];this.rights=[];this.floors=[];this.images=[];this.texts=[];return this.load()};Room.prototype.load=function(){$.getJSON("/numero0/room"+this.id+".json",$.proxy(function(a){this.init(a);$(scr.container).trigger("loaded")},this));return this};
Room.prototype.init=function(a){this.name=a.name||"Room "+this.id;this.position=a.position;this.map=a.map;this.adj=a.adj||[];this.color=a.color;this.artsConstr=a.arts||[];this.soundsConstr=a.sounds||[];this.readMap();rooms[rooms.length]=this;return this};
Room.prototype.getElementsToRender=function(){var a,b,c=[],d=0;for(a in this.tops)if(this.tops.hasOwnProperty(a))for(b in this.tops[a])this.tops[a].hasOwnProperty(b)&&(c[d]=getEdges(this.tops[a][b],"top"),d+=1);for(a in this.bottoms)if(this.bottoms.hasOwnProperty(a))for(b in this.bottoms[a])this.bottoms[a].hasOwnProperty(b)&&(c[d]=getEdges(this.bottoms[a][b],"bottom"),d+=1);for(a in this.lefts)if(this.lefts.hasOwnProperty(a))for(b in this.lefts[a])this.lefts[a].hasOwnProperty(b)&&(c[d]=getEdges(this.lefts[a][b],
"left"),d+=1);for(a in this.rights)if(this.rights.hasOwnProperty(a))for(b in this.rights[a])this.rights[a].hasOwnProperty(b)&&(c[d]=getEdges(this.rights[a][b],"right"),d+=1);for(a=0;a<this.arts.length;a++)b=this.arts[a],b.projection(),b.visible&&(c[d]={type:"art",distance:this.arts[a].distance,art:this.arts[a]},d+=1);return c};Room.prototype.isTop=function(a){return"#"===a||("-"===a||"+"===a)||!1};Room.prototype.isBottom=function(a){return"%"===a||("_"===a||"\u00a4"===a)||!1};
Room.prototype.isLeft=function(a){return"#"===a||("|"===a||"%"===a)||!1};Room.prototype.isRight=function(a){return"+"===a||("!"===a||"\u00a4"===a)||!1};Room.prototype.isInside=function(a){return"."!==a||!1};Room.prototype.isNoWall=function(a){return","===a||!1};Room.prototype.getArtConstr=function(a){for(var b,c=0;c<this.artsConstr.length;c++)if(b=this.artsConstr[c],b.id===a)return b;console.log("artId not found")};
Room.prototype.readMap=function(){var a,b,c,d,e,f,h,g,m,n,l;for(a=0;a<this.map.length;a++){d=this.map.length-(a+1);for(b=0;b<this.map[a].length;b+=2)if(c=b/2,e=this.map[a][b],f=this.map[a][b+1],this.isInside(e)){h=this.putFaceToWall(this.tops,this.isTop(e),d,faceMaker.top(this,c,d));g=this.putFaceToWall(this.bottoms,this.isBottom(e),d,faceMaker.bottom(this,c,d));m=this.putFaceToWall(this.lefts,this.isLeft(e),c,faceMaker.left(this,c,d));n=this.putFaceToWall(this.rights,this.isRight(e),c,faceMaker.right(this,
c,d));l=void 0;if("."!==f){f=this.getArtConstr(f);if(this.isTop(f.side||e))l=faceMaker.art(this,h,f),this.arts.push(l);if(this.isBottom(f.side||e))l=faceMaker.art(this,g,f),this.arts.push(l);if(this.isLeft(f.side||e))l=faceMaker.art(this,m,f),this.arts.push(l);if(this.isRight(f.side||e))l=faceMaker.art(this,n,f),this.arts.push(l)}this.floors.push(faceMaker.floor(this,c,d,[h,g,m,n],l))}}};
Room.prototype.putFaceToWall=function(a,b,c,d){if(b)return a[c]||(a[c]=[]),0===a[c].length&&a[c].push([]),a[c][a[c].length-1].push(d),d;a[c]&&(0===a[c].length||0!==a[c][a[c].length-1].length)&&a[c].push([]);return null};Room.prototype.makeSounds=function(){var a,b;for(a=0;a<this.soundsConstr.length;a++)b=this.soundsConstr[a],this.sounds.push(new Sound(b))};Room.prototype.removeSounds=function(){var a;for(a=0;a<this.sounds.length;a++)this.sounds[a].remove()};var renderer={renderAll:function(){this.renderFloor();this.renderAiming();this.renderRooms()},renderFloor:function(){var a=camera.trig.sinX*(100*params.unit+camera.focalLength),b=Math.abs(camera.focalLength/(camera.trig.cosX*(100*params.unit+camera.focalLength)-camera.focalLength+camera.focalLength)*camera.zoom.value)||1E4,a=parseInt(0.5*scr.height+a*b,10);a<scr.height&&(scr.ctx.beginPath(),scr.ctx.rect(0,a,scr.width,scr.height-a),scr.ctx.fillStyle=colors.floor,scr.ctx.fill())},renderAiming:function(){cursor.aimedFace&&
"floor"===cursor.aimedFace.f.type&&(face=cursor.aimedFace,face.projection(),scr.ctx.beginPath(),scr.ctx.lineTo(face.p0.X,face.p0.Y),cursor.aimedFace.f.art||(scr.ctx.lineTo((5*face.p0.X+face.p1.X)/6,(5*face.p0.Y+face.p1.Y)/6),scr.ctx.moveTo((face.p0.X+5*face.p1.X)/6,(face.p0.Y+5*face.p1.Y)/6)),scr.ctx.lineTo(face.p1.X,face.p1.Y),cursor.aimedFace.f.art||(scr.ctx.lineTo((5*face.p1.X+face.p2.X)/6,(5*face.p1.Y+face.p2.Y)/6),scr.ctx.moveTo((face.p1.X+5*face.p2.X)/6,(face.p1.Y+5*face.p2.Y)/6)),scr.ctx.lineTo(face.p2.X,
face.p2.Y),cursor.aimedFace.f.art||(scr.ctx.lineTo((5*face.p2.X+face.p3.X)/6,(5*face.p2.Y+face.p3.Y)/6),scr.ctx.moveTo((face.p2.X+5*face.p3.X)/6,(face.p2.Y+5*face.p3.Y)/6)),scr.ctx.lineTo(face.p3.X,face.p3.Y),cursor.aimedFace.f.art||(scr.ctx.lineTo((5*face.p3.X+face.p0.X)/6,(5*face.p3.Y+face.p0.Y)/6),scr.ctx.moveTo((face.p3.X+5*face.p0.X)/6,(face.p3.Y+5*face.p0.Y)/6)),scr.ctx.lineTo(face.p0.X,face.p0.Y),scr.ctx.closePath(),cursor.aimedFace.f.art?(scr.ctx.fillStyle=colors.aimedFloor,scr.ctx.fill()):
(scr.ctx.strokeStyle=colors.aimedFloor,scr.ctx.stroke()))},renderRooms:function(){var a,b=[],c,d=0;for(a=0;a<rooms.length;a++){c=rooms[a].getElementsToRender();for(j=0;j<c.length;j++)b[d]=c[j],d+=1}renderer.renderElementsToRender(b)},renderElementsToRender:function(a){a=insertSortDistance(a);for(i=0;i<a.length;i++)("top"===a[i].type||"bottom"===a[i].type||"left"===a[i].type||"right"===a[i].type)&&renderer.facesMerged(a[i]),"art"===a[i].type&&(face=a[i].art,face.render())},facesMerged:function(a){var b,
c;b=a.points;a=colors[a.type];if(2<b.length){scr.ctx.beginPath();for(var d=0;d<b.length;d++)c=b[d],scr.ctx.lineTo(c.X,c.Y);scr.ctx.closePath();void 0===colors.gradient||SLOW?scr.ctx.fillStyle=a||"#F9F9F9":(b=scr.ctx.createLinearGradient(b[b.length-1].X,b[b.length-1].Y,b[parseInt((b.length-1)/2,10)].X,b[parseInt((b.length-1)/2,10)].Y),b.addColorStop(0,a),b.addColorStop(1,colors.gradient),scr.ctx.fillStyle=b);scr.ctx.lineWidth=1;scr.ctx.strokeStyle="#E4E4E4";scr.ctx.fill();scr.ctx.stroke()}}},CanvasEl=
{Triangle:function(a,b,c,d){this.p0=b;this.p1=c;this.p2=d;this.next=!1;this.d=b.tx*(d.ty-c.ty)-c.tx*d.ty+d.tx*c.ty+(c.tx-d.tx)*b.ty;this.pmy=c.ty-d.ty;this.pmx=c.tx-d.tx;this.pxy=d.tx*c.ty-c.tx*d.ty;a.firstTriangle?a.prev.next=this:a.firstTriangle=this;a.prev=this},Image:function(a,b,c){this.canvas=a;this.ctx=a.getContext("2d");"string"==typeof b&&(this.texture=new Image,this.texture.src=b);"object"==typeof b&&(this.texture=b);this.lev=c;this.isLoading=!0;this.prev=this.firstTriangle=this.firstPoint=
!1}};
CanvasEl.Image.prototype.loading=function(){var a,b,c,d,e,f;e=0;if(this.texture.complete&&this.texture.width){this.isLoading=!1;f=[];for(a=0;a<=this.lev;a++)for(b=0;b<=this.lev;b++)c=a*(this.texture.width/this.lev),d=b*(this.texture.height/this.lev),c={tx:c,ty:d,nx:c/this.texture.width,ny:d/this.texture.height,next:!1},f[e]=c,e+=1,this.firstPoint?this.prev.next=c:this.firstPoint=c,this.prev=c;e=this.lev+1;for(a=0;a<this.lev;a++)for(b=0;b<this.lev;b++)new CanvasEl.Triangle(this,f[b+a*e],f[b+a*e+1],
f[b+(a+1)*e]),new CanvasEl.Triangle(this,f[b+(a+1)*e+1],f[b+(a+1)*e],f[b+a*e+1])}};
CanvasEl.Image.prototype.render=function(a,b,c,d,e){var f=[a,b,c,d];if(this.isLoading)this.loading();else{var h=this.firstPoint;do{var g=a.X+h.ny*(d.X-a.X),m=a.Y+h.ny*(d.Y-a.Y);h.px=g+h.nx*(b.X+h.ny*(c.X-b.X)-g);h.py=m+h.nx*(b.Y+h.ny*(c.Y-b.Y)-m);h=h.next}while(h);d=this.canvas.width;h=this.canvas.height;g=this.firstTriangle;do{a=g.p0;b=g.p1;c=g.p2;var m=(a.px+b.px+c.px)/3,n=(a.py+b.py+c.py)/3,l=!0;if(0>m||m>d||0>n||n>h)if(0>Math.max(a.px,b.px,c.px)||Math.min(a.px,b.px,c.px)>d||0>Math.max(a.py,b.py,
c.py)||Math.min(a.py,b.py,c.py)>h)l=!1;if(l){this.ctx.save();this.ctx.beginPath();var q,p,l=m-a.px;q=n-a.py;p=Math.max(Math.abs(l),Math.abs(q));this.ctx.moveTo(a.px-2*(l/p),a.py-2*(q/p));l=m-b.px;q=n-b.py;p=Math.max(Math.abs(l),Math.abs(q));this.ctx.lineTo(b.px-2*(l/p),b.py-2*(q/p));l=m-c.px;q=n-c.py;p=Math.max(Math.abs(l),Math.abs(q));this.ctx.lineTo(c.px-2*(l/p),c.py-2*(q/p));this.ctx.closePath();this.ctx.clip();this.ctx.transform(-(a.ty*(c.px-b.px)-b.ty*c.px+c.ty*b.px+g.pmy*a.px)/g.d,(b.ty*c.py+
a.ty*(b.py-c.py)-c.ty*b.py-g.pmy*a.py)/g.d,(a.tx*(c.px-b.px)-b.tx*c.px+c.tx*b.px+g.pmx*a.px)/g.d,-(b.tx*c.py+a.tx*(b.py-c.py)-c.tx*b.py-g.pmx*a.py)/g.d,(a.tx*(c.ty*b.px-b.ty*c.px)+a.ty*(b.tx*c.px-c.tx*b.px)+g.pxy*a.px)/g.d,(a.tx*(c.ty*b.py-b.ty*c.py)+a.ty*(b.tx*c.py-c.tx*b.py)+g.pxy*a.py)/g.d);this.ctx.drawImage(this.texture,0,0);this.ctx.restore()}g=g.next}while(g);this.ctx.beginPath();for(a=0;a<f.length;a++)this.ctx.lineTo(f[a].X,f[a].Y);this.ctx.closePath();this.ctx.lineWidth=1;this.ctx.strokeStyle=
e||"white";this.ctx.stroke()}};window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();
var insertSortTheta=function(a){for(var b=1;b<a.length;b++){for(var c=a[b],d=b;a[d-1]&&a[d-1].theta>c.theta;)a[d]=a[d-1],--d;a[d]=c}return a},insertSortDistance=function(a){for(var b=1;b<a.length;b++){for(var c=a[b],d=b;a[d-1]&&a[d-1].distance<c.distance;)a[d]=a[d-1],--d;a[d]=c}return a},getParameters=function(){for(var a=window.location.href.replace(/.*#!/,"").split("&"),b={},c=0;c<a.length;c++){var d=a[c].split("=");b[d[0]]=d[1]}return b},showHtml=function(a){$("#artClearView").html(a);$("#artClearView").fadeIn(1E3);
$("#artClearView").one("click",function(){remHtml()})},remHtml=function(){$("#artClearView").fadeOut(1E3,function(){$("#artClearView").empty()})},getEdges=function(a,b){if(0===a.length)return{distance:-99999,points:[]};var c,d,e,f,h,g=0,m=0;for(c=0;c<a.length;c++)if(d=a[c],d.projection(),d.visible){!e&&(!f&&!h)&&(e=f=a[c],h=a[c].distance);m+=1;g+=d.distance;if("left"===b||"right"===b)d.f.z<e.f.z&&(e=d),d.f.z>f.f.z&&(f=d);if("top"===b||"bottom"===b)d.f.x<e.f.x&&(e=d),d.f.x>f.f.x&&(f=d)}if(!e&&!f&&
!h)return{distance:-99999,points:[]};if("top"===b||"left"===b)return{type:b,distance:g/m,points:[e.p3,e.p0,f.p1,f.p2]};if("bottom"===b||"right"===b)return{type:b,distance:g/m,points:[e.p1,e.p2,f.p3,f.p0]}},getEdges2=function(a,b){var c,d=[],e=0,f,h,g,m,n,l,q,p,s,r,t,u=0;for(c=n=h=g=m=0;c<a.length;c++)f=a[c],f.projection(),f.visible&&(h+=f.f.x,g+=f.f.y,m+=f.f.z,n++,f.p0.behind||(d[e]=f.p0,e+=1),f.p1.behind||(d[e]=f.p1,e+=1),f.p2.behind||(d[e]=f.p2,e+=1),f.p3.behind||(d[e]=f.p3,e+=1));h=h/n||0;g=g/
n||0;m=m/n||0;d=remMany(d,equalsCoord,4);if(0<d.length){e=d[0];for(c=0;c<d.length;c++)u<d[c].distance&&(u=d[c].distance),f=e.x-h,n=e.y-g,l=e.z-m,q=d[c].x-h,p=d[c].y-g,s=d[c].z-m,"x"===b&&(r=n*p+l*s,t=n*s-l*p),"y"===b&&(r=f*q+l*s,t=l*q-f*s),"z"===b&&(r=f*q+n*p,t=f*p-n*q),f=Math.atan(t/r)||0,d[c].theta=0<=r?f:f+Math.PI,d[c].cosTheta=r,d[c].sinTheta=t;d=insertSortTheta(d)}return{distance:u,points:d}},remMany=function(a,b,c){var d,e,f=[],h=[],g;for(d=0;d<a.length;d++){g=!1;for(e=0;e<h.length;e++)b(a[d],
h[e])&&(f[e]+=1,g=!0);g||(h.push(a[d]),f.push(1))}for(d=0;d<h.length;d++)f[d]>=c&&(h.splice(d,1),f.splice(d,1),d--);return h},equalsCoord=function(a,b){return a.x===b.x&&a.y===b.y&&a.z===b.z};var startCpt=function resetCpt(){!SLOW&&50>cpt&&(console.log(cpt),console.log("Slow Mode"),SLOW=!0);SLOW&&100<cpt&&(console.log(cpt),console.log("Fast Mode"),SLOW=!1);cpt=0;setTimeout(resetCpt,5E3)},enteredRoom=function(a){var b,c,d;rooms[0].removeSounds();for(k=0;k<rooms.length;k++)if(rooms[k].id===a){a=rooms[k];rooms[k]=rooms[0];rooms[0]=a;d=rooms[0];for(a=0;a<d.adj.length;a++){c=null;for(b=1;b<rooms.length;b++)if(rooms[b].id===d.adj[a]){c=rooms[b];break}c||new Room(d.adj[a])}for(b=1;b<rooms.length;b++){c=
null;for(a=0;a<d.adj.length;a++)if(rooms[b].id===d.adj[a]){c=rooms[b];break}c||rooms.splice(b,1)}d.makeSounds();break}return rooms},init=function(){var a=getParameters();scr=new Screen({container:"screen",canvas:"canvas"});new Room(a.room||1);$(scr.container).one("loaded",function(){enteredRoom(a.room||1);camera=new Camera(rooms[0].floors[parseInt(rooms[0].floors.length/2,10)].pc.x,rooms[0].floors[parseInt(rooms[0].floors.length/2,10)].pc.z);cursor=new Cursor("screen",params.cursorX,params.cursorY);
if(void 0!==a.art){var b;for(b=0;b<rooms[0].floors.length;b++)rooms[0].floors[b].f.art&&rooms[0].floors[b].f.art.f.artId===a.art&&camera.targetToFace(rooms[0].floors[b])}requestAnimFrame(run);$(scr.canvas).fadeIn(3E3,function(){setTimeout(remHtml,1E3)})});startCpt()},run=function(){requestAnimFrame(run);scr.ctx.clearRect(0,0,scr.width,scr.height);camera.move();renderer.renderAll();cpt++};init();var Sound=function(a){this.audio=new Audio;this.audio.src=a.src;"true"===a.play&&(this.audio.volume=0.8,this.audio.play());this.activateControls()};
Sound.prototype.activateControls=function(){"none"===$("#audio").css("display")&&$("#audio").fadeIn(1E3);$("#s_mute").click($.proxy(function(){this.formerVolume=this.audio.volume;this.audio.volume=0},this));$("#s_lower").click($.proxy(function(){this.audio.volume=0===this.audio.volume?this.formerVolume||0:this.audio.volume-0.1},this));$("#s_higher").click($.proxy(function(){this.audio.volume=0===this.audio.volume?this.formerVolume||1:this.audio.volume+0.1},this))};
Sound.prototype.remove=function(){this.audio.pause();$("#audio").fadeOut(1E3)};
